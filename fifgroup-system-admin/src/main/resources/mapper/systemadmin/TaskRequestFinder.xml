<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="co.id.fifgroup.systemadmin.finder.TaskRequestFinder">

	<resultMap id="BaseResultMap" type="co.id.fifgroup.systemadmin.dto.TaskRequestDTO">
		<id column="TASK_REQUEST_ID" property="id" jdbcType="DECIMAL" />
		<result column="TASK_RUNNER_ID" property="taskRunnerId" jdbcType="DECIMAL" />
		<result column="TASK_RUNNER_NAME" property="taskRunner.taskRunnerName" jdbcType="VARCHAR" />
		<result column="TASK_ID" property="taskId" jdbcType="DECIMAL" />
		<result column="TASK_NAME" property="taskName" jdbcType="VARCHAR" />
		<result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP" />
		<result column="DATE_SUBMITTED" property="dateSubmitted" jdbcType="TIMESTAMP" />
		<result column="TASK_PHASE" property="taskRequestDetail.taskPhase" jdbcType="VARCHAR" />
		<result column="TASK_STATUS" property="taskRequestDetail.taskStatus" jdbcType="VARCHAR" />
		<result column="CREATED_BY" property="createdBy" jdbcType="VARCHAR" />
		<result column="CREATION_DATE" property="creationDate" jdbcType="TIMESTAMP" />
		<result column="TASK_TYPE" property="taskType" jdbcType="VARCHAR"/>
		<result column="OUTPUT_FORMAT" property="outputFormat" jdbcType="VARCHAR"/>
		<result column="AFTER_COMPLETED" property="afterCompleted" jdbcType="VARCHAR"/>
		<result column="PRINTER_ID" property="printerId" jdbcType="DECIMAL"/>
		<result column="DAY_NUM" property="dayNum" jdbcType="DECIMAL"/>
		<result column="DATE_STARTED" property="taskRequestDetail.dateStarted" jdbcType="TIMESTAMP"/>
		<result column="DATE_COMPLETED" property="taskRequestDetail.dateCompleted" jdbcType="TIMESTAMP"/>
		<result column="REQUEST_DETAIL_ID" property="taskRequestDetail.id" jdbcType="DECIMAL" />
		<result column="OUTPUT_LOG" property="taskRequestDetail.outputLog" jdbcType="VARCHAR" />
	</resultMap>
	<!-- add comment biar ke-merge,TPS ITSM 15102208595234 20151002 -->

	<resultMap id="TotalBaseResultMap" type="java.lang.Integer">
		<result column="TOTAL" jdbcType="DECIMAL" />
	</resultMap>
	<resultMap id="taskRequestDetailMap" type="co.id.fifgroup.systemadmin.domain.TaskRequestDetail">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Apr 18 
			11:31:27 ICT 2013. -->
		<id column="REQUEST_DETAIL_ID" jdbcType="DECIMAL" property="id" />
		<result column="TASK_REQUEST_ID" jdbcType="DECIMAL" property="taskRequestId" />
		<result column="DATE_STARTED" jdbcType="TIMESTAMP" property="dateStarted" />
		<result column="DATE_COMPLETED" jdbcType="TIMESTAMP" property="dateCompleted" />
		<result column="TASK_STATUS" jdbcType="VARCHAR" property="taskStatus" />
		<result column="TASK_PHASE" jdbcType="VARCHAR" property="taskPhase" />
		<result column="OUTPUT_LOG" jdbcType="VARCHAR" property="outputLog" />
		<result column="OUTPUT_FILE" jdbcType="VARCHAR" property="outputFile" />
	</resultMap>
	
	<resultMap id="TaskParameterValueResult" type="co.id.fifgroup.systemadmin.domain.TaskParameterValue">
		<id column="TASK_PARAMETER_VALUE_ID" jdbcType="DECIMAL" property="id" />
		<result column="TASK_PARAMETER_ID" jdbcType="DECIMAL" property="taskParameterId" />
		<result column="TASK_REQUEST_ID" jdbcType="DECIMAL" property="taskRequestId" />
		<result column="VALUE" jdbcType="VARCHAR" property="value" />
		<result column="CREATED_BY" jdbcType="DECIMAL" property="createdBy" />
		<result column="CREATION_DATE" jdbcType="TIMESTAMP" property="creationDate" />
		<result column="LAST_UPDATED_BY" jdbcType="DECIMAL" property="lastUpdatedBy" />
		<result column="LAST_UPDATE_DATE" jdbcType="TIMESTAMP"
			property="lastUpdateDate" />
	</resultMap>

	<select id="selectByExampleWithRowbounds" parameterType="co.id.fifgroup.systemadmin.dto.TaskRequestDTO" resultMap="BaseResultMap">
		SELECT
		TR.TASK_REQUEST_ID,
		TR.TASK_RUNNER_ID,
		TR.TASK_ID,
		TR.DATE_SUBMITTED,
		TR.LAST_UPDATE_DATE,
		TR.CREATED_BY,
		TR.CREATION_DATE,
		TR.OUTPUT_FORMAT,
		TR.AFTER_COMPLETED,
		TR.PRINTER_ID,
		TRD.REQUEST_DETAIL_ID,	
		TRD.TASK_PHASE,
		TRD.TASK_STATUS,
		TRD.DATE_STARTED,
		TRD.DATE_COMPLETED,
		TRD.OUTPUT_LOG,
		TK.TASK_NAME,
		TK.TASK_TYPE,
		RH.TASK_RUNNER_NAME,
		TR.DAY_NUM
		FROM SAM_TASK_REQUESTS TR
		JOIN SAM_TASK_RUNNER_HDR RH ON RH.TASK_RUNNER_ID = TR.TASK_RUNNER_ID
		JOIN SAM_TASKS TK ON TK.TASK_ID = TR.TASK_ID
		JOIN SAM_TASK_REQUEST_DETAILS TRD ON TRD.TASK_REQUEST_ID = TR.TASK_REQUEST_ID
		<where>
			<if test="example.id != null">
				TR.TASK_REQUEST_ID = #{example.id, jdbcType=DECIMAL}
			</if>
			<if test="example.taskRunnerId != null">
				AND UPPER(TR.TASK_RUNNER_ID) = #{example.taskRunnerId,
				jdbcType=DECIMAL}
			</if>
			<if test="example.taskRequestDetail.taskPhase != null">
				AND UPPER(TRD.TASK_PHASE) LIKE
				UPPER(#{example.taskRequestDetail.taskPhase, jdbcType=VARCHAR})
			</if>
			<if test="example.taskRequestDetail.taskStatus != null">
				AND UPPER(TRD.TASK_STATUS) LIKE
				UPPER(#{example.taskRequestDetail.taskStatus, jdbcType=VARCHAR})
			</if>
			<if test="example.dateSubmitted != null">
				AND TR.DATE_SUBMITTED LIKE #{example.dateSubmitted, jdbcType=DATE}
			</if>
			<if test="example.dateSubmittedFrom != null">
				AND TRUNC(TR.DATE_SUBMITTED) BETWEEN TRUNC(#{example.dateSubmittedFrom, jdbcType=DATE}) AND TRUNC(#{example.dateSubmittedTo, jdbcType=DATE})
			</if>
			<if test="example.createdBy != null">
				AND TR.created_by = #{example.createdBy, jdbcType=DECIMAL}
			</if>
		</where>
		ORDER BY TR.TASK_REQUEST_ID DESC
	</select>
	
	<select id="getTaskRequestDetailToBeCanceled" parameterType="map"
		resultMap="taskRequestDetailMap">
		SELECT 
		TRD.REQUEST_DETAIL_ID,
		TRD.TASK_REQUEST_ID,
		TRD.DATE_STARTED,
		TRD.DATE_COMPLETED,
		TRD.TASK_STATUS,
		TRD.TASK_PHASE,
		TRD.OUTPUT_LOG,
		TRD.OUTPUT_FILE
		FROM SAM_TASK_REQUEST_DETAILS TRD
		JOIN SAM_TASK_REQUESTS TR ON TRD.TASK_REQUEST_ID = TR.TASK_REQUEST_ID
		WHERE TR.PARENT_REQUEST_ID = #{parentRequestId, jdbcType=VARCHAR}
		<if test="taskPhase!=null">
		AND TRD.TASK_PHASE = #{taskPhase, jdbcType=VARCHAR}
		</if>
	</select>

	<select id="countTaskRequestDtoByExample" parameterType="co.id.fifgroup.systemadmin.dto.TaskRequestDTO"
		resultMap="TotalBaseResultMap">
		SELECT COUNT(*) AS TOTAL
		FROM SAM_TASK_REQUESTS TR
		JOIN SAM_TASK_RUNNER_HDR RH ON RH.TASK_RUNNER_ID = TR.TASK_RUNNER_ID
		JOIN SAM_TASKS TK ON TK.TASK_ID = TR.TASK_ID
		JOIN SAM_TASK_REQUEST_DETAILS TRD ON TRD.TASK_REQUEST_ID =
		TR.TASK_REQUEST_ID
		<where>
			<if test="example.id != null">
				TR.TASK_REQUEST_ID = #{example.id, jdbcType=DECIMAL}
			</if>
			<if test="example.taskRunnerId != null">
				AND UPPER(TR.TASK_RUNNER_ID) = #{example.taskRunnerId,
				jdbcType=DECIMAL}
			</if>
			<if test="example.taskRequestDetail.taskPhase != null">
				AND UPPER(TRD.TASK_PHASE) LIKE
				UPPER(#{example.taskRequestDetail.taskPhase, jdbcType=VARCHAR})
			</if>
			<if test="example.taskRequestDetail.taskStatus != null">
				AND UPPER(TRD.TASK_STATUS) LIKE
				UPPER(#{example.taskRequestDetail.taskStatus, jdbcType=VARCHAR})
			</if>
			<if test="example.dateSubmitted != null">
				AND TR.DATE_SUBMITTED LIKE #{example.dateSubmitted, jdbcType=DATE}
			</if>
			<if test="example.createdBy != null">
				AND TR.created_by = #{example.createdBy, jdbcType=DECIMAL}
			</if>
		</where>
	</select>
	
	<select id="getTaskParameterValuesByTaskRunnerId" parameterType="java.lang.Long" resultMap="TaskParameterValueResult">
		SELECT * 
		FROM SAM_TASK_PARAMETER_VALUES TPV
		WHERE TPV.TASK_REQUEST_ID IN(
		SELECT TASK_REQUEST_ID
		FROM SAM_TASK_REQUESTS
		WHERE PARENT_REQUEST_ID = (SELECT PARENT_REQUEST_ID FROM SAM_TASK_REQUESTS WHERE TASK_REQUEST_ID = #{id, jdbcType=DECIMAL})
		)
		ORDER BY TPV.TASK_PARAMETER_ID	
	</select>

	<select id="getScheduledOrPendingFirstTaskRequestDetailByTaskRequestId" parameterType="java.lang.Long"
		resultMap="taskRequestDetailMap">
		SELECT * FROM SAM_TASK_REQUEST_DETAILS
		<where>
			<if test="id != null">
				TASK_REQUEST_ID = (#{id, jdbcType=DECIMAL})
			</if>
		</where>
		AND DATE_COMPLETED IS NULL
		AND TASK_PHASE IN ('SCHEDULED','PENDING')
		ORDER BY REQUEST_DETAIL_ID DESC
	</select>
	
	<select id="isJobCompleted" parameterType="Map"
		resultType="java.lang.Boolean">
		select case when count(*) = 0 then 1 else 0 end from Qrtz_Triggers Where Trigger_Name = #{parentRequestId, jdbcType=VARCHAR}
	</select>
</mapper>