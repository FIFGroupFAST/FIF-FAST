<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.id.fifgroup.ssoa.finder.SOPeriodFinder">
	<resultMap id="BaseResultMap" type="co.id.fifgroup.ssoa.dto.SOPeriodDTO">
		<id column="SO_PERIOD_ID" property="soPeriodId" jdbcType="DECIMAL"/>
		<result column="DESCRIPTION" property="description" jdbcType="VARCHAR"/>
		<result column="COMPANY_ID" property="companyId" jdbcType="DECIMAL"/>
		<result column="START_DATE" property="startDate" jdbcType="DATE"/>
		<result column="END_DATE" property="endDate" jdbcType="DATE"/>
		<result column="INVOLVE_BRANCH" property="involveBranch" jdbcType="INTEGER"/>
		<result column="NOT_STARTED_BRANCH" property="notStartedBranch" jdbcType="INTEGER"/>
		<result column="IN_PROCESS_BRANCH" property="inProcessBranch" jdbcType="INTEGER"/>
		<result column="SUBMIT_BRANCH" property="submitBranch" jdbcType="INTEGER"/>
		<result column="APPROVED_BRANCH" property="approveBranch" jdbcType="INTEGER"/>
		<result column="CLOSED_BRANCH" property="closedBranch" jdbcType="INTEGER"/>
		<result column="STATUS_ID" property="statusId" jdbcType="DECIMAL"/>
		<result column="STATUS_CODE" property="statusCode" jdbcType="VARCHAR"/>
		<result column="LAST_NOTIFICATION_DATE" property="lastNotificationDate" jdbcType="DATE"/>
		<result column="CREATED_BY" property="createdBy" jdbcType="DECIMAL"/>
		<result column="CREATION_DATE" property="creationDate" jdbcType="TIMESTAMP"/>
		<result column="LAST_UPDATE_BY" property="lastUpdateBy" jdbcType="DECIMAL"/>
		<result column="FULL_NAME" property="fullName" jdbcType="VARCHAR"/>
		<result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP"/>
		<result column="USER_NAME" property="userName" jdbcType="VARCHAR"/>
		<result column="STATUS_NAME" property="statusName" jdbcType="VARCHAR"/>
		<result column="FULL_NAME" property="fullName" jdbcType="VARCHAR"/>
	</resultMap>
	
		<sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Mar 19 22:59:29 ICT 2013.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
	<select id="selectByExample" resultMap="BaseResultMap" parameterType="co.id.fifgroup.ssoa.domain.SOPeriodExample">
		SELECT DISTINCT
			HD.SO_PERIOD_ID,
			HD.COMPANY_ID,
			HD.DESCRIPTION,
			HD.START_DATE,
			HD.END_DATE,
			HD.INVOLVE_BRANCH,
			HD.NOT_STARTED_BRANCH,
			HD.IN_PROCESS_BRANCH,
			HD.SUBMIT_BRANCH,
			HD.APPROVED_BRANCH,
			HD.CLOSED_BRANCH,
			HD.STATUS_ID,
			HD.STATUS_CODE,
			(L.DESCRIPTION)as STATUS_NAME,
		 	(SELECT CONCAT(concat(PEA.EMPLOYEE_NUMBER,'-'),PEA.FULL_NAME) FROM pea_personal_informations PEA 
                        WHERE ROWNUM = 1 AND PEA.EMPLOYEE_NUMBER = U.USER_NAME) AS FULL_NAME,
			HD.LAST_NOTIFICATION_DATE,
		(SELECT COUNT(*)
		FROM
			SOC_SO_PERIOD_DTL
		WHERE
			SO_PERIOD_ID = HD.SO_PERIOD_ID) AS TASK_COUNT,
			HD.CREATED_BY,
			HD.CREATION_DATE,
			HD.LAST_UPDATE_DATE,
			HD.LAST_UPDATE_BY,
			U.USER_NAME
		FROM
			SOC_SO_PERIOD_HDR HD
		INNER JOIN BSE_LOOKUP_DEPENDENTS L on L.DETAIL_CODE = HD.STATUS_CODE
		LEFT JOIN
			SAM_USERS U ON U.USER_ID = HD.LAST_UPDATE_BY
		<if test="_parameter != null">
      		<include refid="Example_Where_Clause" />
    	</if>
		<if test="orderByClause != null">
             order by ${orderByClause}
    	</if>
	</select>
	<select id="countByExample" resultType="int" parameterType="co.id.fifgroup.ssoa.domain.SOPeriodExample">
		SELECT COUNT(*)
		FROM
			SOC_SO_PERIOD_HDR HD
		INNER JOIN BSE_LOOKUP_DEPENDENTS L on L.DETAIL_CODE = HD.STATUS_CODE
		<if test="_parameter != null">
      		<include refid="Example_Where_Clause" />
    	</if>
		ORDER BY
			HD.LAST_UPDATE_DATE DESC
	</select>
	
	
	<resultMap id="DetailMap" type="co.id.fifgroup.ssoa.dto.SOPeriodDetailDTO">
		<id column="SO_PERIOD_DTL_ID" property="soPeriodDtlId" jdbcType="DECIMAL"/>
		<result column="SO_PERIOD_ID" property="soPeriodId" jdbcType="DECIMAL"/>
		<result column="BRANCH_ID" property="branchId" jdbcType="DECIMAL"/>
		<result column="BRANCH_CODE" property="branchCode" jdbcType="VARCHAR"/>
		<result column="STATUS_ID" property="statusId" jdbcType="DECIMAL"/>
		<result column="STATUS_CODE" property="statusCode" jdbcType="VARCHAR"/>
		<result column="NOTIFICATION_STATUS_ID" property="notificationStatusId" jdbcType="VARCHAR"/>
		<result column="NOTIFICATION_STATUS_CODE" property="notificationStatusCode" jdbcType="VARCHAR"/>
		<result column="BRANCH_NAME" property="branchName" jdbcType="VARCHAR"/>
		<result column="STATUS_NAME" property="statusName" jdbcType="VARCHAR"/>
		<result column="STATUS_NOTIFICATION_NAME" property="notificationStatusName" jdbcType="VARCHAR"/>
		<result column="REPORT_STATUS_NAME" property="reportStatusName" jdbcType="VARCHAR"/>
		<result column="AVM_TRX_ID" property="avmTrxIdSOString" jdbcType="DECIMAL"/>
		
	</resultMap>
	
	<select id="selectDetailByExample" resultMap="DetailMap" parameterType="co.id.fifgroup.ssoa.domain.SOPeriodDetail">
		SELECT DISTINCT
			DT.SO_PERIOD_DTL_ID,
			DT.SO_PERIOD_ID,
			(select AVM_TRX_ID from (SELECT SOH.SO_PERIOD_DTL_ID,SOH.STOCK_OPNAME_ID,SOR.AVM_TRX_ID
          	FROM SOC_STOCK_OPNAME_REPORTING SOR
               JOIN SOC_STOCK_OPNAME_HDR soh
                  ON SOH.STOCK_OPNAME_ID = SOR.STOCK_OPNAME_ID
         	ORDER BY stock_opname_reporting_id DESC) where SO_PERIOD_DTL_ID = DT.SO_PERIOD_DTL_ID and rownum = 1)
          	AS AVM_TRX_ID,
			DT.STATUS_ID,
			DT.STATUS_CODE,
			DT.NOTIFICATION_STATUS_ID,
			DT.NOTIFICATION_STATUS_CODE,
			(case when DT.BRANCH_ID = -1 then 'HEADOFFICE' else (SELECT SUBSTR (ORGANIZATION_CODE, -5) as branch_code from WOS_ORGANIZATIONS where ORGANIZATION_ID = DT.BRANCH_ID and rownum = 1) end )BRANCH_CODE,
    		(case when DT.BRANCH_ID = -1 then 'Head Office' else (SELECT ORGANIZATION_NAME from WOS_ORGANIZATIONS where ORGANIZATION_ID = DT.BRANCH_ID and rownum = 1) end )BRANCH_NAME,
			DT.BRANCH_ID,		
			L.DESCRIPTION as STATUS_NAME,
			L1.DESCRIPTION as STATUS_NOTIFICATION_NAME,
			(SELECT description
	          FROM (  SELECT SOH.SO_PERIOD_DTL_ID,
	                         SOH.STOCK_OPNAME_ID,
	                         bld.description
	                    FROM bse_lookup_dependents bld
	                         JOIN SOC_STOCK_OPNAME_REPORTING SOR
	                            ON SOR.STATUS_CODE = BLD.DETAIL_CODE
	                         JOIN SOC_STOCK_OPNAME_HDR soh
	                            ON SOH.STOCK_OPNAME_ID = SOR.STOCK_OPNAME_ID
	                ORDER BY stock_opname_reporting_id DESC)
	         WHERE SO_PERIOD_DTL_ID = DT.SO_PERIOD_DTL_ID AND ROWNUM = 1)
          AS REPORT_STATUS_NAME
		FROM SOC_SO_PERIOD_DTL DT
		INNER JOIN BSE_LOOKUP_DEPENDENTS L on L.DETAIL_CODE = DT.STATUS_CODE
		INNER JOIN BSE_LOOKUP_DEPENDENTS L1 on L1.DETAIL_CODE = DT.NOTIFICATION_STATUS_CODE
		LEFT JOIN SAM_USERS U ON U.USER_ID = DT.LAST_UPDATE_BY
		INNER JOIN WOS_ORGANIZATIONS wo on WO.ORGANIZATION_ID = DT.BRANCH_ID
		<where>
			<if test="example.soPeriodId != null">
				DT.SO_PERIOD_ID =#{example.soPeriodId,jdbcType=DECIMAL}
			</if>
			
			<if test="example.branchId != null">
				AND DT.BRANCH_Id LIKE #{example.branchId,jdbcType=DECIMAL}
			</if>
			<if test="example.branchCode != null">
				AND UPPER(wo.ORGANIZATION_CODE) LIKE
				(UPPER('%' || #{example.branchCode,jdbcType=VARCHAR} || '%'))
			</if>
			<if test="example.branchName != null">
				AND UPPER(wo.ORGANIZATION_NAME) LIKE
				(UPPER('%' || #{example.branchName,jdbcType=VARCHAR} || '%'))
			</if>
			<if test="example.statusCode != null">
				 AND UPPER(DT.STATUS_CODE) LIKE
				(UPPER('%' || #{example.statusCode,jdbcType=VARCHAR} || '%'))
			</if>
		</where>
		
	</select>
	<select id="countDetailByExample" resultType="int" parameterType="co.id.fifgroup.ssoa.domain.SOPeriodDetail">
		SELECT COUNT(*)
		FROM
			SOC_SO_PERIOD_DTL DT
		LEFT JOIN
			SAM_USERS U ON U.USER_ID = DT.LAST_UPDATE_BY
	
		<where>
			<if test="example.soPeriodId != null">
				DT.SO_PERIOD_ID =#{example.soPeriodId,jdbcType=DECIMAL}
			</if>
			<if test="example.branchCode != null">
				AND UPPER(BRANCH_CODE) LIKE
				(UPPER('%' || #{example.branchCode,jdbcType=VARCHAR} || '%'))
			</if>
			<if test="example.branchName != null">
				AND UPPER(BRANCH_NAME) LIKE
				(UPPER('%' || #{example.branchName,jdbcType=VARCHAR} || '%'))
			</if>
			<if test="example.statusCode != null">
				 AND UPPER(DT.STATUS_CODE) LIKE
				(UPPER(#{example.statusCode,jdbcType=VARCHAR}))
			</if>
		</where>
	
	</select>
	
	<resultMap type="co.id.fifgroup.core.ui.lookup.KeyValue" id="BaseResultMapKeyValue">
		<result column="KEY" property="key" javaType="java.lang.Object"/>
		<result column="VALUE" property="value" javaType="java.lang.Object"/>
		<result column="DESCRIPTION" property="description" javaType="java.lang.Object"/>
	</resultMap>
  <select id="getLookupKeyValues" parameterType="map" resultMap="BaseResultMapKeyValue">
		SELECT DISTINCT
		    bld.DETAIL_CODE KEY,
			bld.DETAIL_CODE VALUE,
			bld.DESCRIPTION DESCRIPTION,
			bld.SEQ_NUMBER
		FROM bse_lookup_hdr blh
    	join BSE_LOOKUP_DEPENDENTS bld on bld.lookup_id = blh.lookup_id
		WHERE
      		blh.name = #{lookupName}
      	<if test="key != null">
			AND	UPPER(bld.DETAIL_CODE) like 
				(UPPER(#{key}))
      	</if>
      	ORDER BY bld.SEQ_NUMBER ASC
	</select>
	
</mapper>